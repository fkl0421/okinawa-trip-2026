<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Okinawa Trip 2026</title>
    
    <!-- PWA Settings for App-like Experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#F0F9FF">
    
    <!-- App Icon (Base64 placeholder, looks like a blue plane) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%2306B6D4'/%3E%3Cpath d='M352 256L160 128V384L352 256Z' fill='white'/%3E%3C/svg%3E">
    <link rel="icon" type="image/png" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%2306B6D4'/%3E%3Cpath d='M352 256L160 128V384L352 256Z' fill='white'/%3E%3C/svg%3E">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Config Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#F0F9FF',      // Sky 50
                            text: '#164E63',    // Cyan 900
                            accent: '#0E7490',  // Cyan 700
                            highlight: '#06B6D4', // Cyan 500
                            card: '#FFFFFF',
                            border: '#CFFAFE',  // Cyan 100
                            funpass: '#10B981',  // Emerald 500
                            ai: '#8B5CF6'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F0F9FF;
            color: #164E63;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            /* Safe area for iPhone X+ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            padding-bottom: 100px;
        }

        .tab-content.active {
            display: block;
        }

        /* Custom UI Elements */
        .category-radio:checked + div,
        .currency-radio:checked + div,
        .payment-radio:checked + div,
        .split-currency-radio:checked + div {
            background-color: #06B6D4;
            color: white;
            border-color: #06B6D4;
        }

        .custom-checkbox input:checked + div {
            background-color: #06B6D4;
            border-color: #06B6D4;
        }
        .custom-checkbox input:checked + div:after {
            content: '';
            display: block;
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            position: absolute;
            top: 2px;
            left: 5px;
        }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary i.fa-chevron-down { transform: rotate(180deg); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="fixed top-0 w-full z-40 bg-muji-bg/95 backdrop-blur-md border-b border-muji-border transition-all duration-300 shadow-sm pt-[env(safe-area-inset-top)]" id="main-header">
        <div class="max-w-md mx-auto px-5 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-widest text-muji-text flex items-center">
                    <i class="fa-solid fa-water mr-2 text-muji-highlight"></i>OKINAWA
                </h1>
                <p class="text-xs text-muji-accent mt-0.5 font-medium">2026.03.08 - 03.14</p>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold bg-muji-text text-white px-2 py-1 rounded mb-1 shadow-sm">JX302 / JX303</div>
                <div id="sync-status-indicator" class="text-[10px] text-gray-400 flex items-center justify-end mt-1">
                    <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>連線中...
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 mt-24 max-w-md mx-auto w-full px-4">
        
        <!-- MODULE 1: PLAN -->
        <div id="tab-plan" class="tab-content active">
            <div id="itinerary-container"></div>
        </div>

        <!-- MODULE 2: SPLIT BILL -->
        <div id="tab-split" class="tab-content">
            <h2 class="text-2xl font-light mb-6 text-center tracking-widest border-b pb-2 border-muji-border text-muji-text">分帳小幫手</h2>
            
            <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-5 mb-6">
                <h3 class="text-sm font-bold text-muji-text mb-3 flex items-center"><i class="fa-solid fa-users mr-2 text-muji-highlight"></i>成員管理</h3>
                <div class="flex flex-wrap gap-2 mb-4" id="people-list-container"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-person-name" placeholder="輸入名字" class="flex-1 bg-blue-50 border border-muji-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition">
                    <button onclick="addPerson()" class="bg-muji-highlight text-white px-4 py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-cyan-600 transition">新增</button>
                </div>
            </div>

            <div id="split-form-container" class="bg-white rounded-2xl shadow-sm border border-muji-border p-5 mb-6 scroll-mt-24">
                <h3 id="split-form-title" class="text-sm font-bold text-muji-text mb-3 flex items-center border-l-4 border-muji-highlight pl-2">
                    <i class="fa-solid fa-money-bill-wave mr-2 text-muji-highlight"></i>新增公款支出
                </h3>
                <div class="space-y-4">
                     <div class="flex gap-2">
                        <div class="flex bg-gray-100 rounded-lg p-1 w-1/2">
                            <label class="flex-1 cursor-pointer"><input type="radio" name="split-currency" value="JPY" class="hidden split-currency-radio peer" checked><div class="text-center py-2 rounded-md text-xs font-bold text-gray-500 peer-checked:bg-muji-highlight peer-checked:text-white transition-all">JPY</div></label>
                            <label class="flex-1 cursor-pointer"><input type="radio" name="split-currency" value="TWD" class="hidden split-currency-radio peer"><div class="text-center py-2 rounded-md text-xs font-bold text-gray-500 peer-checked:bg-muji-highlight peer-checked:text-white transition-all">TWD</div></label>
                        </div>
                        <div class="relative w-1/2">
                            <span class="absolute left-2 top-2.5 text-xs text-gray-400">匯率</span>
                            <input type="number" id="split-rate" step="0.001" placeholder="0.22" class="w-full bg-blue-50 border border-muji-border rounded-lg pl-10 pr-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition">
                        </div>
                     </div>
                     <input type="text" id="split-item" placeholder="項目 (如: 晚餐、車資)" class="w-full bg-blue-50 border border-muji-border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition">
                     <div class="flex gap-3">
                        <input type="number" id="split-amount" placeholder="金額" class="w-2/3 bg-blue-50 border border-muji-border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition">
                        <select id="split-payer" class="w-1/3 bg-blue-50 border border-muji-border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></select>
                     </div>
                     <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                         <div class="text-xs text-gray-500 mb-2 font-bold flex justify-between items-center">
                             <span>分攤人 (預設全選)</span>
                             <button onclick="toggleAllSplitInvolved()" class="text-muji-highlight hover:underline">全選/取消</button>
                         </div>
                         <div id="split-involved-container" class="grid grid-cols-3 gap-2"></div>
                     </div>
                     <div class="flex gap-2 pt-2">
                        <button id="split-submit-btn" onclick="addSplitExpense()" class="flex-1 bg-muji-text text-white font-bold py-3 rounded-xl shadow-md hover:bg-cyan-900 transition active:scale-95">加入分帳</button>
                        <button id="split-cancel-btn" onclick="cancelSplitEdit()" class="hidden flex-none bg-gray-200 text-gray-600 font-bold py-3 px-5 rounded-xl shadow-sm hover:bg-gray-300 transition">取消</button>
                     </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-muji-text to-muji-accent text-white rounded-2xl p-5 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10"><i class="fa-solid fa-scale-balanced text-6xl"></i></div>
                <h3 class="font-bold mb-3 border-b border-white/20 pb-2 flex items-center"><i class="fa-solid fa-calculator mr-2"></i>結算建議 (TWD)</h3>
                <div id="settlement-results" class="text-sm space-y-2 font-mono min-h-[50px]"><p class="text-white/60 italic">尚未計算... 請點擊下方按鈕</p></div>
                <button onclick="calculateSettlement()" class="mt-4 w-full bg-white/20 hover:bg-white/30 text-white font-bold py-2 rounded-lg transition text-sm backdrop-blur-sm border border-white/30">計算分帳 (誰給誰多少)</button>
            </div>

            <div>
                 <h3 class="text-lg font-bold text-muji-text mb-3 px-1">分帳紀錄</h3>
                 <div id="split-list" class="space-y-3 pb-8"></div>
            </div>
        </div>

        <!-- MODULE 3: BOOKKEEPING -->
        <div id="tab-wallet" class="tab-content">
            <div class="bg-muji-text text-white rounded-2xl p-6 shadow-lg mb-6 relative overflow-hidden bg-gradient-to-br from-muji-text to-muji-accent">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <div class="text-xs text-blue-100 font-bold tracking-wider mb-1">今日匯率 (JPY → TWD)</div>
                        <div class="flex items-center">
                            <input type="number" id="exchange-rate" step="0.001" class="bg-transparent border-b border-white/30 text-white text-2xl font-mono font-bold w-24 focus:outline-none focus:border-white transition" value="0.220" onchange="syncSplitRate()">
                            <button onclick="fetchLiveRate()" class="ml-2 bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fa-solid fa-rotate-right text-xs"></i></button>
                        </div>
                        <div id="rate-status" class="text-[10px] text-blue-200 mt-1">更新中...</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-blue-100 font-bold tracking-wider mb-1">總支出</div>
                        <div class="text-3xl font-bold font-mono tracking-wider text-white">NT$ <span id="total-twd-display">0</span></div>
                        <div class="text-xs text-blue-200 font-mono mt-1">¥ <span id="total-jpy-display">0</span></div>
                    </div>
                </div>
            </div>
            <button onclick="openExpenseModal()" class="w-full bg-white border-2 border-dashed border-muji-highlight text-muji-highlight font-bold py-4 rounded-2xl hover:bg-blue-50 transition flex items-center justify-center shadow-sm mb-6 text-lg"><i class="fa-solid fa-pen-to-square mr-2"></i> 記一筆</button>
            <div>
                <div class="flex justify-between items-end mb-4 px-1"><h3 class="text-lg font-bold text-muji-text">消費明細</h3></div>
                <div id="expense-list" class="space-y-3 pb-8"></div>
            </div>
        </div>

        <!-- MODULE 4: LISTS -->
        <div id="tab-lists" class="tab-content">
            <div class="mb-8">
                <h2 class="text-lg font-bold mb-4 flex items-center text-muji-text"><i class="fa-solid fa-clipboard-check mr-2 text-muji-highlight"></i>行前準備</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-muji-border overflow-hidden">
                    <div id="checklist-container" class="divide-y divide-gray-50"></div>
                    <div class="p-4 bg-blue-50 border-t border-muji-border">
                        <div class="flex space-x-3">
                            <input type="text" id="new-todo" placeholder="新增項目..." class="flex-1 bg-white border border-muji-border rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-border transition">
                            <button onclick="addTodo()" class="bg-muji-highlight text-white font-bold text-sm px-4 rounded-xl shadow-sm hover:bg-cyan-400 transition">新增</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-muji-text flex items-center"><i class="fa-solid fa-bag-shopping mr-2 text-muji-highlight"></i>待買清單</h2>
                    <button onclick="openShoppingModal()" class="text-xs bg-muji-highlight text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-cyan-600 transition"><i class="fa-solid fa-plus mr-1"></i>新增</button>
                </div>
                <div id="shopping-list-container" class="space-y-3"></div>
            </div>
            <div>
                <h2 class="text-lg font-bold mb-4 flex items-center text-muji-text"><i class="fa-regular fa-note-sticky mr-2 text-muji-highlight"></i>備忘錄</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-5 relative">
                    <textarea id="memo-area" class="w-full h-48 text-sm leading-relaxed text-gray-600 focus:outline-none resize-none bg-transparent" placeholder="輸入備忘錄..."></textarea>
                    <div class="absolute bottom-3 right-5 text-[10px] text-gray-300 font-bold bg-gray-50 px-2 py-1 rounded">自動儲存</div>
                </div>
                <div id="memo-links" class="mt-4 space-y-2"></div>
            </div>
        </div>

        <!-- MODULE 5: INFO -->
        <div id="tab-info" class="tab-content">
            <h2 class="text-2xl font-light mb-6 text-center tracking-widest border-b pb-2 border-muji-border text-muji-text">行程資訊</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-white p-5 rounded-2xl shadow-sm border border-muji-border flex flex-col items-center justify-center text-blue-500 hover:bg-blue-50 transition group">
                    <i class="fa-solid fa-cloud-sun text-3xl mb-2 group-hover:scale-110 transition"></i><span class="text-sm font-bold">天氣預報</span>
                </a>
                <a href="https://translate.google.com/?sl=zh-TW&tl=ja" target="_blank" class="bg-white p-5 rounded-2xl shadow-sm border border-muji-border flex flex-col items-center justify-center text-green-500 hover:bg-green-50 transition group">
                    <i class="fa-solid fa-language text-3xl mb-2 group-hover:scale-110 transition"></i><span class="text-sm font-bold">Google 翻譯</span>
                </a>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-6 mb-6">
                <h3 class="text-lg font-bold border-l-4 border-pink-400 pl-3 mb-4 text-muji-text flex items-center"><i class="fa-solid fa-comments mr-2 text-pink-400"></i>實用日語 100 句</h3>
                <div id="japanese-phrases-container" class="space-y-2"></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-6 mb-6">
                <h3 class="text-lg font-bold border-l-4 border-blue-400 pl-3 mb-4 text-muji-text flex items-center"><i class="fa-solid fa-plane-departure mr-2 text-blue-400"></i>航班資訊</h3>
                <div class="space-y-6 text-sm text-gray-600">
                    <div class="bg-blue-50/50 p-4 rounded-xl">
                        <div class="font-bold text-muji-text mb-2 text-base">去程 JX302 (A321NEO)</div>
                        <div class="flex justify-between mb-1"><span>2026/03/08</span><span class="font-mono font-bold text-muji-accent">13:15 RMQ</span></div>
                        <div class="flex justify-between mb-2"><span>飛行 1h 30m</span><span class="font-mono font-bold text-muji-accent">15:45 OKA</span></div>
                        <div class="text-xs text-gray-500">臺中國際機場 2 航廈 → 那霸國際機場 國際航廈</div>
                    </div>
                    <div class="bg-blue-50/50 p-4 rounded-xl">
                        <div class="font-bold text-muji-text mb-2 text-base">回程 JX303 (A321NEO)</div>
                        <div class="flex justify-between mb-1"><span>2026/03/14</span><span class="font-mono font-bold text-muji-accent">16:45 OKA</span></div>
                        <div class="flex justify-between mb-2"><span>飛行 1h 50m</span><span class="font-mono font-bold text-muji-accent">17:35 RMQ</span></div>
                        <div class="text-xs text-gray-500">那霸國際機場 國際航廈 → 臺中國際機場 2 航廈</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-6 mb-6">
                <h3 class="text-lg font-bold border-l-4 border-orange-400 pl-3 mb-4 text-muji-text flex items-center"><i class="fa-solid fa-hotel mr-2 text-orange-400"></i>住宿資訊</h3>
                <div class="text-sm text-gray-600 space-y-3">
                    <div class="font-bold text-lg text-muji-text">THE NEST 那覇</div>
                    <p><i class="fa-solid fa-location-dot mr-2 text-gray-400"></i>1 Chome-6-1 Nishi, Naha, Okinawa 900-0036</p>
                    <p><i class="fa-solid fa-phone mr-2 text-gray-400"></i>+81 98-869-8015</p>
                    <a href="https://maps.app.goo.gl/Rh8e9ZCkKiCtbVj96" target="_blank" class="inline-block mt-2 text-muji-highlight font-bold border border-muji-highlight rounded-lg px-3 py-1.5 hover:bg-blue-50 transition">開啟 Google Maps</a>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-6 mb-6">
                <h3 class="text-lg font-bold border-l-4 border-green-400 pl-3 mb-4 text-muji-text flex items-center"><i class="fa-solid fa-car mr-2 text-green-400"></i>租車資訊</h3>
                <div class="text-sm text-gray-600 space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="flex justify-between"><span class="text-gray-500">預約號碼</span><span class="font-bold text-muji-text font-mono">W7617726</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">公司</span><span class="font-bold">ORIX 租車</span></div>
                    <hr class="border-gray-200">
                    <div><span class="block text-gray-500 text-xs mb-1">車型</span><div class="font-bold">沖縄限定キャンペーンWAクラス 禁煙（ワゴン）</div></div>
                    <div><span class="block text-gray-500 text-xs mb-1">取車 (出發)</span><div class="font-bold">2026/03/09 08:00</div><div class="text-xs">旭橋駅西店 (TEL: 098-866-0543)</div></div>
                    <div><span class="block text-gray-500 text-xs mb-1">還車 (返却)</span><div class="font-bold">2026/03/13 18:00</div><div class="text-xs">旭橋駅西店 (TEL: 098-866-0543)</div></div>
                    <a href="https://maps.app.goo.gl/GjgT81YL4QyiEmXT8" target="_blank" class="inline-block mt-2 text-muji-highlight font-bold border border-muji-highlight rounded-lg px-3 py-1.5 hover:bg-blue-50 transition w-full text-center">開啟 Google Maps (取還車地點)</a>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-muji-border p-6">
                <h3 class="text-lg font-bold border-l-4 border-red-400 pl-3 mb-4 text-muji-text">緊急聯絡</h3>
                <ul class="space-y-4 text-sm">
                    <li class="flex justify-between border-b border-gray-50 pb-2"><span class="text-gray-600">警察局</span><a href="tel:110" class="text-red-500 font-bold bg-red-50 px-2 py-0.5 rounded">110</a></li>
                    <li class="flex justify-between border-b border-gray-50 pb-2"><span class="text-gray-600">火警/救護車</span><a href="tel:119" class="text-red-500 font-bold bg-red-50 px-2 py-0.5 rounded">119</a></li>
                    <li class="flex flex-col gap-1"><span class="text-gray-600">台北駐日經濟文化代表處 (那霸)</span><a href="tel:098-862-7008" class="text-blue-500 font-bold self-end bg-blue-50 px-2 py-0.5 rounded">098-862-7008</a></li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur border-t border-muji-border pb-safe z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center justify-center w-full h-full text-muji-accent hover:text-muji-text transition duration-300">
                <i class="fa-solid fa-map-location-dot text-xl mb-1 transform transition group-hover:scale-110"></i><span class="text-[10px] font-medium">行程</span>
            </button>
            <button onclick="switchTab('split')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-muji-accent hover:text-muji-text transition duration-300">
                <i class="fa-solid fa-people-arrows text-xl mb-1"></i><span class="text-[10px] font-medium">分帳</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-muji-accent hover:text-muji-text transition duration-300">
                <i class="fa-solid fa-file-invoice-dollar text-xl mb-1"></i><span class="text-[10px] font-medium">記帳</span>
            </button>
            <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-muji-accent hover:text-muji-text transition duration-300">
                <i class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px] font-medium">清單</span>
            </button>
            <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-muji-accent hover:text-muji-text transition duration-300">
                <i class="fa-solid fa-circle-info text-xl mb-1"></i><span class="text-[10px] font-medium">資訊</span>
            </button>
        </div>
    </nav>

    <!-- Modals (Itinerary, DayInfo, Expense, Shopping, PhotoViewer) -->
    <div id="event-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden"><h3 id="event-modal-title" class="text-xl font-bold text-muji-text mb-4 border-l-4 border-muji-highlight pl-3">新增行程</h3><div class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">時間</label><input type="time" id="event-time" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">景點名稱</label><input type="text" id="event-title" placeholder="請輸入景點名稱" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">描述/備註</label><textarea id="event-desc" rows="3" placeholder="備註..." class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></textarea></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Google Maps 搜尋關鍵字</label><input type="text" id="event-map" placeholder="用於導航連結" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div class="flex items-center space-x-2 pt-1"><input type="checkbox" id="event-funpass" class="w-5 h-5 text-muji-highlight rounded focus:ring-muji-highlight border-gray-300"><span class="text-sm font-medium text-gray-700">標記為 FunPass 景點</span></div></div><div class="flex gap-3 mt-6"><button onclick="closeEventModal()" class="flex-1 bg-gray-200 text-gray-600 font-bold py-2.5 rounded-xl shadow-sm hover:bg-gray-300 transition">取消</button><button onclick="saveEvent()" class="flex-1 bg-muji-highlight text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-cyan-600 transition">儲存</button></div></div></div>
    <div id="day-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden"><h3 class="text-xl font-bold text-muji-text mb-4 border-l-4 border-muji-highlight pl-3">編輯單日資訊</h3><div class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">日期</label><input type="text" id="day-date" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">主題 (Title)</label><input type="text" id="day-title" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">標籤 (Tag)</label><input type="text" id="day-tag" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div></div><div class="flex gap-3 mt-6"><button onclick="closeDayModal()" class="flex-1 bg-gray-200 text-gray-600 font-bold py-2.5 rounded-xl shadow-sm hover:bg-gray-300 transition">取消</button><button onclick="saveDayInfo()" class="flex-1 bg-muji-highlight text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-cyan-600 transition">儲存</button></div></div></div>
    <div id="expense-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden max-h-[90vh] overflow-y-auto"><h3 id="expense-modal-title" class="text-xl font-bold text-muji-text mb-4 border-l-4 border-muji-highlight pl-3">新增記帳</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">日期</label><input type="date" id="modal-expense-date" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div class="flex bg-gray-100 rounded-lg p-1"><label class="flex-1 cursor-pointer"><input type="radio" name="currency" value="JPY" class="hidden peer" checked onchange="updateModalCurrencyLabel()"><div class="text-center py-2 rounded-md text-sm font-bold text-gray-500 peer-checked:bg-muji-highlight peer-checked:text-white transition-all">JPY 日幣</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="currency" value="TWD" class="hidden peer" onchange="updateModalCurrencyLabel()"><div class="text-center py-2 rounded-md text-sm font-bold text-gray-500 peer-checked:bg-muji-highlight peer-checked:text-white transition-all">TWD 台幣</div></label></div><div><label class="block text-xs font-bold text-gray-500 mb-1">金額</label><div class="relative"><span id="modal-currency-symbol" class="absolute left-3 top-2.5 text-gray-400 font-bold">¥</span><input type="number" id="modal-expense-amount" placeholder="0" class="w-full bg-blue-50 border border-muji-border rounded-lg pl-8 pr-3 py-2.5 text-lg font-bold text-muji-text focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div></div><div><label class="block text-xs font-bold text-gray-500 mb-2">付款方式</label><div class="flex bg-gray-100 rounded-lg p-1"><label class="flex-1 cursor-pointer"><input type="radio" name="payment" value="cash" class="hidden peer" checked><div class="text-center py-2 rounded-md text-sm font-bold text-gray-500 peer-checked:bg-muji-highlight peer-checked:text-white transition-all">現金</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="payment" value="card" class="hidden peer"><div class="text-center py-2 rounded-md text-sm font-bold text-gray-500 peer-checked:bg-muji-highlight peer-checked:text-white transition-all">信用卡</div></label></div></div><div><label class="block text-xs font-bold text-gray-500 mb-2">分類</label><div class="grid grid-cols-4 gap-2"><label class="cursor-pointer"><input type="radio" name="category" value="transport" class="hidden category-radio"><div class="flex flex-col items-center justify-center p-2 rounded-lg border border-gray-200 text-gray-400 hover:bg-gray-50 transition h-16"><i class="fa-solid fa-train-subway text-lg mb-1"></i><span class="text-[10px]">交通</span></div></label><label class="cursor-pointer"><input type="radio" name="category" value="food" class="hidden category-radio" checked><div class="flex flex-col items-center justify-center p-2 rounded-lg border border-gray-200 text-gray-400 hover:bg-gray-50 transition h-16"><i class="fa-solid fa-utensils text-lg mb-1"></i><span class="text-[10px]">飲食</span></div></label><label class="cursor-pointer"><input type="radio" name="category" value="hotel" class="hidden category-radio"><div class="flex flex-col items-center justify-center p-2 rounded-lg border border-gray-200 text-gray-400 hover:bg-gray-50 transition h-16"><i class="fa-solid fa-bed text-lg mb-1"></i><span class="text-[10px]">住宿</span></div></label><label class="cursor-pointer"><input type="radio" name="category" value="ticket" class="hidden category-radio"><div class="flex flex-col items-center justify-center p-2 rounded-lg border border-gray-200 text-gray-400 hover:bg-gray-50 transition h-16"><i class="fa-solid fa-ticket text-lg mb-1"></i><span class="text-[10px]">門票</span></div></label><label class="cursor-pointer"><input type="radio" name="category" value="shopping" class="hidden category-radio"><div class="flex flex-col items-center justify-center p-2 rounded-lg border border-gray-200 text-gray-400 hover:bg-gray-50 transition h-16"><i class="fa-solid fa-bag-shopping text-lg mb-1"></i><span class="text-[10px]">購物</span></div></label><label class="cursor-pointer"><input type="radio" name="category" value="other" class="hidden category-radio"><div class="flex flex-col items-center justify-center p-2 rounded-lg border border-gray-200 text-gray-400 hover:bg-gray-50 transition h-16"><i class="fa-solid fa-ellipsis text-lg mb-1"></i><span class="text-[10px]">其他</span></div></label></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">名稱</label><input type="text" id="modal-expense-item" placeholder="例如: 拉麵" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">備註</label><textarea id="modal-expense-note" rows="2" placeholder="備註..." class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></textarea></div><div><label class="w-full bg-white border border-dashed border-muji-highlight text-muji-accent rounded-xl flex flex-col items-center justify-center py-3 cursor-pointer hover:bg-blue-50 transition shadow-sm"><i class="fa-solid fa-camera mb-1"></i><span class="text-xs font-bold">上傳照片 / 拍照</span><input type="file" id="modal-expense-photo" accept="image/*" class="hidden" onchange="previewImageModal(this)"></label><div id="modal-photo-preview-container" class="hidden mt-2 relative"><img id="modal-photo-preview" class="h-24 w-full rounded-lg object-cover border border-gray-200"><button onclick="clearModalPhoto()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-md"><i class="fa-solid fa-times text-[10px]"></i></button></div></div></div><div class="flex gap-3 mt-6"><button onclick="closeExpenseModal()" class="flex-1 bg-gray-200 text-gray-600 font-bold py-2.5 rounded-xl shadow-sm hover:bg-gray-300 transition">取消</button><button onclick="saveExpenseFromModal()" class="flex-1 bg-muji-highlight text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-cyan-600 transition">儲存</button></div></div></div>
    <div id="shopping-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden"><h3 id="shopping-modal-title" class="text-xl font-bold text-muji-text mb-4 border-l-4 border-muji-highlight pl-3">新增待買項目</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">商品名稱</label><input type="text" id="shopping-name" placeholder="請輸入商品名稱" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">預計金額 / 預算</label><input type="number" id="shopping-amount" placeholder="金額 (選填)" class="w-full bg-blue-50 border border-muji-border rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-muji-highlight transition"></div><div><label class="w-full bg-white border border-dashed border-muji-highlight text-muji-accent rounded-xl flex flex-col items-center justify-center py-3 cursor-pointer hover:bg-blue-50 transition shadow-sm"><i class="fa-solid fa-camera mb-1"></i><span class="text-xs font-bold">上傳參考照片</span><input type="file" id="shopping-photo" accept="image/*" class="hidden" onchange="previewShoppingImage(this)"></label><div id="shopping-photo-preview-container" class="hidden mt-2 relative"><img id="shopping-photo-preview" class="h-32 w-full rounded-lg object-cover border border-gray-200"><button onclick="clearShoppingPhoto()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-md"><i class="fa-solid fa-times text-[10px]"></i></button></div></div></div><div class="flex gap-3 mt-6"><button onclick="closeShoppingModal()" class="flex-1 bg-gray-200 text-gray-600 font-bold py-2.5 rounded-xl shadow-sm hover:bg-gray-300 transition">取消</button><button onclick="saveShoppingItem()" class="flex-1 bg-muji-highlight text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-cyan-600 transition">儲存</button></div></div></div>
    <div id="photo-viewer-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onclick="closePhotoViewer()"><img id="photo-viewer-img" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl" src="" alt="Photo"><button onclick="closePhotoViewer()" class="absolute top-4 right-4 text-white text-2xl p-2 bg-black/50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-black/70"><i class="fa-solid fa-times"></i></button></div>

    <!-- Firebase Script (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Firebase Config (Hardcoded)
        const firebaseConfig = {
          apiKey: "AIzaSyAJUIf5tiClF9undnwtWuQLet0PPMEn4As",
          authDomain: "myokinawatrip.firebaseapp.com",
          projectId: "myokinawatrip",
          storageBucket: "myokinawatrip.firebasestorage.app",
          messagingSenderId: "701641648314",
          appId: "1:701641648314:web:ec0a843a6b18b7fb083a83",
          measurementId: "G-5X1BMRL975"
        };

        // Global state for Firebase
        window.db = null;
        const TRIP_ID = 'okinawa_trip_data';

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            const analytics = getAnalytics(app);
            
            // Start listening to DB changes
            initFirebaseListener();
            updateSyncStatus(true);
        } catch (e) {
            console.error("Firebase Init Error", e);
            updateSyncStatus(false);
        }

        function updateSyncStatus(connected) {
            const el = document.getElementById('sync-status-indicator');
            if (connected) {
                el.innerHTML = '<i class="fa-solid fa-cloud mr-1 text-green-400"></i>已連線同步中';
            } else {
                el.innerHTML = '<i class="fa-solid fa-mobile-screen mr-1 text-gray-400"></i>離線模式';
            }
        }

        function initFirebaseListener() {
            if (!window.db) return;
            
            // Listen for changes from Cloud
            onSnapshot(doc(window.db, "trips", TRIP_ID), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    
                    // Update local variables from Cloud
                    if(data.itinerary) itineraryData = JSON.parse(data.itinerary);
                    if(data.people) people = JSON.parse(data.people);
                    if(data.splitExpenses) splitExpenses = JSON.parse(data.splitExpenses);
                    if(data.expenses) expenses = JSON.parse(data.expenses);
                    if(data.todos) todos = JSON.parse(data.todos);
                    if(data.shoppingList) shoppingList = JSON.parse(data.shoppingList);
                    if(data.memo) {
                        const memoEl = document.getElementById('memo-area');
                        if(memoEl) memoEl.value = data.memo;
                    }

                    // Re-render based on current active tab
                    // We simply call all render functions to be safe, they are fast enough
                    // But to avoid flickering on current view, we check
                    // Actually, just render everything is safer for sync consistency
                    
                    renderItinerary(); // Also handles day content
                    renderPeople();
                    renderSplitList();
                    renderExpenses();
                    updateTotalDisplay();
                    renderTodos();
                    renderShoppingList();
                    // renderGuide(); // Removed Guide
                    const memo = document.getElementById('memo-area');
                    if(memo) extractLinks(memo.value);
                }
            });
        }

        // Hook into data saving functions to push to Cloud
        window.saveDataToCloud = async function() {
            if (!window.db) return; // Local mode only if db fail
            
            const data = {
                itinerary: JSON.stringify(itineraryData),
                people: JSON.stringify(people),
                splitExpenses: JSON.stringify(splitExpenses),
                expenses: JSON.stringify(expenses),
                todos: JSON.stringify(todos),
                shoppingList: JSON.stringify(shoppingList),
                memo: document.getElementById('memo-area') ? document.getElementById('memo-area').value : ""
            };
            
            try {
                await setDoc(doc(window.db, "trips", TRIP_ID), data, { merge: true });
            } catch (e) {
                console.error("Cloud Save Error", e);
            }
        }
    </script>

    <!-- Main Logic -->
    <script>
        // Data Variables
        let itineraryData = [];
        let people = [];
        let splitExpenses = [];
        let expenses = [];
        let todos = [];
        let shoppingList = [];
        
        // Initial Data Load (Fallback to LocalStorage if offline, then Cloud will overwrite)
        function loadData() {
            // ... (Same Default Data as before) ...
            const defaultItinerary = [
                {day:"Day 1",date:"3/8 週日",title:"那霸抵達",tag:"無車日",events:[{time:"16:00",title:"那霸機場 (OKA) 抵達",desc:"搭乘星宇航空 JX302 (14:15-16:40)。出關領行李。",info:"機型: A321NEO, 飛行時間: 1小時30分。抵達那霸國際機場 國際航廈。",image:""},{time:"17:00",title:"珀塔瑪豬肉蛋飯糰",desc:"機場 4F 美食區。",highlight:true,info:"必吃沖繩靈魂美食！推薦炸蝦塔塔醬口味，現點現做，熱騰騰的午餐肉配上厚蛋燒超美味。",image:""},{time:"18:00",title:"交通移動",desc:"單軌電車至旭橋站 → 飯店 Check-in。",info:"Yui-Rail 單軌電車是那霸市區最方便的交通工具。可使用 IC 卡 (Suica/ICOCA) 或購買一日券。",image:""},{time:"19:00",title:"鳥玉 (泉崎店)",desc:"步行前往晚餐。",map:"鳥と卵の専門店 鳥玉 泉崎店",info:"專門使用新鮮雞蛋的料理店，親子丼滑嫩濃郁，南蠻炸雞也是一絕，非常適合親子用餐。",image:""}]},
                {day:"Day 2",date:"3/9 週一",title:"南部水族館",tag:"租車",events:[{time:"09:00",title:"步行取車 (ORIX)",desc:"步行約 25 分鐘前往 DMM 水族館。",map:"ORIX Rent-a-car Naha Nishimachi",info:"預約編號: W7617726。取車地點: 旭橋駅西店。請記得攜帶台灣駕照正本、日文譯本與護照。",image:""},{time:"10:00",title:"DMM Kariyushi 水族館",desc:"最新光影水族館。",map:"DMM Kariyushi Aquarium",funpass:true,info:"結合最新影像技術的新型水族館。必看透明玻璃地板水槽，彷彿走在水面上，還有樹懶等可愛動物。",image:""},{time:"12:00",title:"iias 沖繩豐崎",desc:"購物中心午餐。",info:"位於水族館旁的大型商場，美食街選擇眾多，也有 A&W 漢堡。頂樓可眺望海景。",image:""},{time:"13:30",title:"豐崎美麗 SUN 海灘",desc:"玩沙踏浪。",map:"Toyosaki Chura Sun Beach",info:"沖繩最大的人工海灘，沙質細緻，海水清澈。適合小朋友玩沙與踏浪，夕陽景色也很美。",image:""},{time:"16:00",title:"瀨長島海風露台",desc:"看夕陽/晚餐。",map:"Senagajima Umikaji Terrace",info:"有「沖繩小希臘」之稱的純白建築群。可以近距離看飛機起降，擁有無敵海景與眾多特色小店。",image:""}]},
                {day:"Day 3",date:"3/10 週二",title:"北部經典",tag:"北部",events:[{time:"07:30",title:"出發前往北部",desc:"車程約 1 小時 45 分鐘。",info:"走沖繩自動車道 (高速公路) 前往北部。沿途可欣賞海景，建議中途在休息站稍作停留。",image:""},{time:"09:30",title:"沖繩美麗海水族館",desc:"黑潮之海/海豚秀。",map:"Okinawa Churaumi Aquarium",funpass:true,info:"沖繩必訪地標！擁有世界級巨大的「黑潮之海」水槽，鯨鯊與鬼蝠魟悠游其中，戶外還有免費的海豚表演。",image:""},{time:"12:00",title:"Inoh 景觀餐廳",desc:"館內午餐。",info:"位於水族館內的自助餐廳，擁有一整排面海的落地窗，可以一邊享用沖繩料理一邊欣賞伊江島海景。",image:""},{time:"14:00",title:"名護鳳梨園",desc:"搭遊園車/試吃。",map:"Nago Pineapple Park",funpass:true,info:"搭乘可愛的鳳梨造型自動遊園車穿梭在熱帶叢林中，還有恐龍探險區。必吃鳳梨冰淇淋與試吃鳳梨蛋糕。",image:""},{time:"17:00",title:"回程",desc:"高速公路休息站或那霸市區晚餐。",info:"傍晚許田交流道易塞車，建議提早出發或做好塞車準備。晚餐可選擇簡單的拉麵或回到市區再吃。",image:""}]},
                {day:"Day 4",date:"3/11 週三",title:"中部海中公園",tag:"中部",events:[{time:"08:30",title:"出發前往中部",desc:"車程約 1 小時 30 分鐘。",info:"前往恩納村方向，沿途海岸線風景優美。",image:""},{time:"10:00",title:"部瀨名海中公園",desc:"海中塔/玻璃船。",map:"Busena Marine Park",funpass:true,info:"沖繩本島唯一的海中展望塔，走下螺旋梯即可觀察海底熱帶魚。鯨魚造型玻璃底船也是人氣體驗。",image:""},{time:"12:30",title:"永旺夢樂城 Rycom",desc:"午餐/逛街。",map:"AEON MALL Okinawa Rycom",info:"沖繩最大的購物中心之一，有巨大的水族箱。美食街選擇豐富，還有寶可夢中心可逛。",image:""},{time:"16:00",title:"美國村",desc:"散步/拍照。",map:"American Village Okinawa",info:"充滿異國風情的休閒區域，色彩繽紛的建築非常好拍。傍晚時分點燈後氣氛更佳，適合散步。",image:""},{time:"18:00",title:"Kijimuna 塔可飯",desc:"晚餐。",map:"Taco Rice Cafe Kijimuna Depot Island",info:"必吃沖繩特色美食「塔可飯」。這裡的歐姆蛋塔可飯（Omotaco）滑嫩順口，小朋友也敢吃。",image:""}]},
                {day:"Day 5",date:"3/12 週四",title:"浦添放電",tag:"中部",events:[{time:"09:30",title:"浦添大公園",desc:"Teada 廣場新遊具。",map:"Urasoe Great Park",info:"擁有超長溜滑梯的知名公園。推薦前往 C 區的 Teada 廣場，有較新且適合幼童的大型遊具。",image:""},{time:"12:00",title:"港川外人住宅區",desc:"午餐/文青點心。",map:"Minatogawa Stateside Town",info:"前美軍眷舍改建的文青聚落，每棟平房都有編號與可愛配色。必買 oHacorte 水果塔與 Houki Boshi 可麗露。",image:""},{time:"14:30",title:"San-A PARCO CITY",desc:"商場逛街/晚餐。",map:"San-A Ishikawa City",info:"浦添西海岸最新最大的商場，擁有無敵海景。3F 兒童區與母嬰用品非常齊全，適合家庭客。",image:""}]},
                {day:"Day 6",date:"3/13 週五",title:"動物與還車",tag:"還車",events:[{time:"09:00",title:"出發",desc:"",info:"準備出發前往今天的行程。",image:""},{time:"09:30",title:"西來院達摩寺",desc:"祈福。",map:"Daruma Temple Naha",info:"位於首里城附近，供奉達摩祖師。這裡充滿紅色的達摩不倒翁，以祈求健康、考運與安產聞名。",image:""},{time:"11:00",title:"沖繩兒童王國",desc:"Zoo/博物館 (午餐在園內)。",map:"Okinawa Zoo & Museum",funpass:true,info:"結合動物園與神奇博物館的親子景點。可以近距離觀察獅子、大象等動物，還有室內互動設施。",image:""},{time:"15:30",title:"加油 & 還車",desc:"ORIX 那霸西町店。",map:"ORIX Rent-a-car Naha Nishimachi",info:"還車地點: 旭橋駅西店。請記得在還車前加滿油，並保留收據。那霸市區傍晚易塞車，請預留充裕時間。",image:""},{time:"19:00",title:"Jack's Steak House",desc:"步行前往晚餐。",map:"Jack's Steak House",info:"沖繩傳奇美式牛排館，創立於1953年。依照店外的紅綠燈判斷排隊狀況，牛排軟嫩，是當地人的最愛。",image:""}]},
                {day:"Day 7",date:"3/14 週六",title:"最後漫步",tag:"返台",events:[{time:"09:30",title:"波上宮 / 波之上海灘",desc:"走路可達。",map:"Naminoue Shrine",info:"琉球八社之首，也是那霸市內唯一的海灘神社。建築矗立在珊瑚礁懸崖上，紅瓦與藍海形成絕美對比。",image:""},{time:"11:00",title:"早午餐 / 退房",desc:"",info:"整理行李，辦理退房手續。確保沒有遺漏物品。",image:""},{time:"12:00",title:"前往機場",desc:"單軌電車至那霸機場站。",info:"搭乘單軌電車前往那霸機場，車程約12分鐘。建議提早抵達機場辦理登機。",image:""},{time:"13:00",title:"機場國內線",desc:"購物/賦歸。搭乘星宇航空 JX303 (17:50-18:30)。",info:"機型: A321NEO, 飛行時間: 1小時50分。回程班機 JX303，16:45起飛。國內線航廈非常好逛，有各種沖繩限定伴手禮、蝦餅、紅芋塔等，把握最後採買機會。",image:""}]}
            ];
            
            itineraryData = JSON.parse(localStorage.getItem('itinerary')) || defaultItinerary;
            people = JSON.parse(localStorage.getItem('people')) || [];
            splitExpenses = JSON.parse(localStorage.getItem('splitExpenses')) || [];
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            todos = JSON.parse(localStorage.getItem('todos')) || [
                {text:"護照",done:false},{text:"日文譯本駕照 / 台灣駕照",done:false},{text:"網卡 / Roaming 設定",done:false},{text:"行動電源",done:false},{text:"個人藥品",done:false},{text:"Visit Japan Web 填寫",done:false}
            ];
            shoppingList = JSON.parse(localStorage.getItem('shoppingList')) || [];
        }
        
        function saveData(key, val) {
            localStorage.setItem(key, JSON.stringify(val));
            if(window.saveDataToCloud) window.saveDataToCloud();
        }

        /* --- 1. RENDER ITINERARY --- */
        let currentDayIndex = 0;
        let editingEvent = null;

        function renderItinerary() {
            let tabsHtml = `<div id="day-tabs-container" class="flex overflow-x-auto space-x-2 pb-2 mb-4 no-scrollbar cursor-grab select-none">`;
            itineraryData.forEach((day, index) => {
                const isActive = index === currentDayIndex;
                const activeClass = isActive ? 'bg-muji-highlight text-white shadow-md ring-2 ring-blue-200' : 'bg-white text-muji-accent border border-muji-border hover:bg-blue-50';
                tabsHtml += `<button onclick="switchDay(${index})" class="flex-shrink-0 px-4 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap ${activeClass}">${day.day}</button>`;
            });
            tabsHtml += `</div>`;

            let weatherHtml = `<div id="daily-weather" class="mb-6 bg-gradient-to-r from-blue-100 to-blue-50 p-4 rounded-xl flex items-center justify-between shadow-sm"><div class="flex items-center"><i id="weather-icon" class="fa-solid fa-cloud text-3xl text-muji-accent mr-3"></i><div><div class="text-xs text-gray-500 font-bold">那霸市 目前天氣</div><div class="text-xl font-bold text-muji-text"><span id="weather-temp">--</span>°C</div></div></div><div class="text-right"><div class="text-xs text-gray-500">體感溫度</div><div class="text-sm font-bold text-muji-accent"><span id="weather-feels">--</span>°C</div></div></div>`;

            const day = itineraryData[currentDayIndex];
            let contentHtml = `
                <div class="bg-white rounded-2xl shadow-sm border border-muji-border overflow-hidden animate-fade-in mb-6">
                    <div class="bg-blue-50/50 px-5 py-4 border-b border-muji-border flex justify-between items-center">
                        <div class="flex-1"><div class="flex items-center gap-2"><h3 class="font-bold text-xl text-muji-text">${day.date}</h3><button onclick="openEditDayModal(${currentDayIndex})" class="text-gray-300 hover:text-muji-highlight transition"><i class="fa-solid fa-pen-to-square text-sm"></i></button></div><p class="text-sm text-muji-accent mt-0.5 font-medium">${day.title}</p></div>
                        <span class="text-xs bg-muji-highlight text-white px-2.5 py-1 rounded-full shadow-sm font-bold tracking-wide">${day.tag}</span>
                    </div>
                    <div class="p-5 relative">
                        <div class="absolute left-7 top-6 bottom-6 w-0.5 bg-gray-100"></div>
                        <div class="space-y-8">
                            ${day.events.map((event, eventIndex) => `
                                <div class="relative pl-10 group">
                                    <div class="absolute left-0.5 top-1.5 w-4 h-4 rounded-full border-2 border-white ring-1 ring-muji-border ${event.highlight ? 'bg-muji-highlight shadow-md scale-110 ring-muji-highlight' : 'bg-gray-200'} z-10 transition-transform group-hover:scale-110"></div>
                                    <div class="flex flex-col gap-3">
                                        <div>
                                            <div class="flex justify-between items-start">
                                                <span class="text-xs font-mono text-muji-accent block mb-1 bg-gray-50 inline-block px-1.5 py-0.5 rounded font-bold">${event.time}</span>
                                                <div class="flex space-x-2"><button onclick="openEditEventModal(${currentDayIndex}, ${eventIndex})" class="text-gray-400 hover:text-muji-accent"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deleteItineraryEvent(${currentDayIndex}, ${eventIndex})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div>
                                            </div>
                                            <h4 class="font-bold text-base text-gray-800 ${event.highlight ? 'text-muji-highlight' : ''} mb-1 flex items-center flex-wrap gap-2">
                                                ${event.title}
                                                ${event.funpass ? '<span class="text-[10px] bg-muji-funpass text-white px-1.5 py-0.5 rounded-full font-bold shadow-sm inline-flex items-center"><i class="fa-solid fa-ticket mr-1"></i>FunPass</span>' : ''}
                                                ${event.map ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.map)}" target="_blank" class="inline-flex items-center justify-center bg-blue-50 text-muji-highlight w-6 h-6 rounded-full hover:bg-muji-highlight hover:text-white transition shadow-sm border border-blue-100"><i class="fa-solid fa-location-dot text-xs"></i></a>` : ''}
                                            </h4>
                                            <p class="text-sm text-gray-500 leading-relaxed mb-2">${event.desc}</p>
                                        </div>
                                        ${event.info ? `<div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-100 shadow-sm transition relative"><div class="p-3"><p class="text-xs text-gray-600 leading-relaxed"><i class="fa-solid fa-circle-info text-muji-highlight mr-1"></i>${event.info}</p></div></div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <button onclick="openAddEventModal(${currentDayIndex})" class="w-full bg-white border-2 border-dashed border-muji-highlight text-muji-highlight font-bold py-3 rounded-2xl hover:bg-blue-50 transition flex items-center justify-center shadow-sm"><i class="fa-solid fa-plus mr-2"></i> 新增行程</button>
            `;

            document.getElementById('itinerary-container').innerHTML = tabsHtml + weatherHtml + contentHtml;
            setupDragScroll();
            fetchWeather();
        }

        function switchDay(index) { currentDayIndex = index; renderItinerary(); }

        function setupDragScroll() {
            const slider = document.getElementById('day-tabs-container');
            let isDown = false, startX, scrollLeft;
            slider.addEventListener('mousedown', (e) => { isDown = true; slider.classList.add('cursor-grabbing'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
            slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('cursor-grabbing'); });
            slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('cursor-grabbing'); });
            slider.addEventListener('mousemove', (e) => { if(!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 2; slider.scrollLeft = scrollLeft - walk; });
        }

        // Itinerary Edit Logic
        function openAddEventModal(day) { editingEvent = null; setupEventModal("新增行程", "09:00", "", "", "", false); }
        function openEditEventModal(d, e) { const ev = itineraryData[d].events[e]; editingEvent = {d, e}; setupEventModal("編輯行程", ev.time, ev.title, ev.desc, ev.map, ev.funpass); }
        function setupEventModal(title, time, name, desc, map, fun) {
            document.getElementById('event-modal-title').innerText = title;
            document.getElementById('event-time').value = time;
            document.getElementById('event-title').value = name;
            document.getElementById('event-desc').value = desc || "";
            document.getElementById('event-map').value = map || "";
            document.getElementById('event-funpass').checked = fun || false;
            document.getElementById('event-modal').classList.remove('hidden');
        }
        function closeEventModal() { document.getElementById('event-modal').classList.add('hidden'); }
        function saveEvent() {
            const newEv = {
                time: document.getElementById('event-time').value,
                title: document.getElementById('event-title').value,
                desc: document.getElementById('event-desc').value,
                map: document.getElementById('event-map').value,
                funpass: document.getElementById('event-funpass').checked,
                image: "", info: "" // Preserve empty
            };
            if(!newEv.title) return alert("請輸入名稱");
            
            if(editingEvent) {
                // Keep old info
                newEv.info = itineraryData[editingEvent.d].events[editingEvent.e].info;
                itineraryData[editingEvent.d].events[editingEvent.e] = newEv;
            } else {
                itineraryData[currentDayIndex].events.push(newEv);
                itineraryData[currentDayIndex].events.sort((a,b) => a.time.localeCompare(b.time));
            }
            saveData('itinerary', itineraryData);
            renderItinerary();
            closeEventModal();
        }
        function deleteItineraryEvent(d, e) { if(confirm("確定刪除?")) { itineraryData[d].events.splice(e, 1); saveData('itinerary', itineraryData); renderItinerary(); } }

        function openEditDayModal(d) {
             const day = itineraryData[d];
             document.getElementById('day-date').value = day.date;
             document.getElementById('day-title').value = day.title;
             document.getElementById('day-tag').value = day.tag;
             document.getElementById('day-modal').classList.remove('hidden');
        }
        function closeDayModal() { document.getElementById('day-modal').classList.add('hidden'); }
        function saveDayInfo() {
             itineraryData[currentDayIndex].date = document.getElementById('day-date').value;
             itineraryData[currentDayIndex].title = document.getElementById('day-title').value;
             itineraryData[currentDayIndex].tag = document.getElementById('day-tag').value;
             saveData('itinerary', itineraryData);
             renderItinerary();
             closeDayModal();
        }

        async function fetchWeather() {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=26.2124&longitude=127.6809&current=temperature_2m,apparent_temperature,weather_code&timezone=Asia%2FTokyo");
                const data = await res.json();
                const iconEl = document.getElementById('weather-icon');
                if(iconEl) {
                    const c = data.current.weather_code;
                    iconEl.className = `fa-solid ${c<=3?'fa-sun':c<=48?'fa-cloud':c<=67?'fa-cloud-rain':'fa-bolt'} text-3xl text-muji-accent mr-3`;
                    document.getElementById('weather-temp').innerText = data.current.temperature_2m;
                    document.getElementById('weather-feels').innerText = data.current.apparent_temperature;
                }
            } catch(e) {}
        }

        /* --- 2. SPLIT BILL --- */
        let editingSplitId = null;
        function renderPeople() {
            document.getElementById('people-list-container').innerHTML = people.map((p,i) => `<div class="bg-blue-100 text-muji-accent px-3 py-1 rounded-full text-sm font-bold flex items-center">${p}<button onclick="removePerson(${i})" class="ml-2 text-red-400"><i class="fa-solid fa-times"></i></button></div>`).join('');
            document.getElementById('split-payer').innerHTML = people.map(p => `<option value="${p}">${p} 先付</option>`).join('');
            document.getElementById('split-involved-container').innerHTML = people.map(p => `<label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border border-gray-200"><input type="checkbox" class="w-4 h-4 text-muji-highlight rounded border-gray-300 split-involved-check" value="${p}" checked><span class="text-sm text-gray-700">${p}</span></label>`).join('');
        }
        function addPerson() { const v = document.getElementById('new-person-name').value.trim(); if(v && !people.includes(v)) { people.push(v); saveData('people', people); document.getElementById('new-person-name').value=''; renderPeople(); } }
        function removePerson(i) { if(confirm("刪除成員?")) { people.splice(i, 1); saveData('people', people); renderPeople(); } }
        function toggleAllSplitInvolved() { const c = document.querySelectorAll('.split-involved-check'); const all = Array.from(c).every(x=>x.checked); c.forEach(x=>x.checked = !all); }
        
        function addSplitExpense() {
            const item = document.getElementById('split-item').value;
            const amount = parseFloat(document.getElementById('split-amount').value);
            const payer = document.getElementById('split-payer').value;
            const curr = document.querySelector('input[name="split-currency"]:checked').value;
            const rate = parseFloat(document.getElementById('split-rate').value) || 0.22;
            const inv = Array.from(document.querySelectorAll('.split-involved-check:checked')).map(x=>x.value);
            
            if(!item || isNaN(amount) || !payer || inv.length===0) return alert("資料不完整");
            
            const obj = { id: editingSplitId || Date.now(), item, amount, currency: curr, rate, amountTWD: curr==='JPY'?Math.round(amount*rate):amount, payer, involved: inv };
            
            if(editingSplitId) {
                const idx = splitExpenses.findIndex(x=>x.id===editingSplitId);
                if(idx!==-1) splitExpenses[idx] = obj;
                cancelSplitEdit();
            } else {
                splitExpenses.unshift(obj);
                document.getElementById('split-item').value = '';
                document.getElementById('split-amount').value = '';
            }
            saveData('splitExpenses', splitExpenses);
            renderSplitList();
        }

        function editSplitExpense(id) {
            const e = splitExpenses.find(x=>x.id===id);
            if(!e) return;
            editingSplitId = id;
            document.getElementById('split-item').value = e.item;
            document.getElementById('split-amount').value = e.amount;
            document.getElementById('split-payer').value = e.payer;
            document.getElementById('split-rate').value = e.rate;
            document.querySelector(`input[name="split-currency"][value="${e.currency}"]`).checked = true;
            const checks = document.querySelectorAll('.split-involved-check');
            checks.forEach(c => c.checked = e.involved.includes(c.value));
            
            document.getElementById('split-form-title').innerText = "編輯公款支出";
            document.getElementById('split-submit-btn').innerText = "儲存";
            document.getElementById('split-cancel-btn').classList.remove('hidden');
            document.getElementById('split-form-container').scrollIntoView({behavior:'smooth'});
        }

        function cancelSplitEdit() {
            editingSplitId = null;
            document.getElementById('split-item').value = '';
            document.getElementById('split-amount').value = '';
            document.getElementById('split-form-title').innerText = "新增公款支出";
            document.getElementById('split-submit-btn').innerText = "加入分帳";
            document.getElementById('split-cancel-btn').classList.add('hidden');
        }

        function deleteSplitExpense(id) {
            if(confirm("刪除?")) {
                splitExpenses = splitExpenses.filter(x=>x.id!==id);
                saveData('splitExpenses', splitExpenses);
                renderSplitList();
            }
        }

        function renderSplitList() {
            const c = document.getElementById('split-list');
            if(!c) return;
            if(splitExpenses.length===0) return c.innerHTML = '<div class="text-center text-gray-400 py-4">無資料</div>';
            c.innerHTML = splitExpenses.map(e => `
                <div class="bg-white p-3 rounded-lg border border-muji-border shadow-sm flex justify-between items-center">
                    <div><div class="font-bold text-gray-800">${e.item}</div><div class="text-xs text-gray-500"><span class="font-bold text-muji-accent">${e.payer}</span> 付 <span class="bg-gray-100 px-1 rounded">${e.involved.length}人分</span></div></div>
                    <div class="text-right"><div class="font-bold text-lg text-muji-highlight">${e.currency==='JPY'?'¥':'NT$'}${e.amount}</div>${e.currency==='JPY'?`<span class="text-xs text-gray-400 block">≈ NT$${e.amountTWD}</span>`:''}
                    <div class="mt-1 space-x-2"><button onclick="editSplitExpense(${e.id})" class="text-xs text-gray-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteSplitExpense(${e.id})" class="text-xs text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>
                </div>`).join('');
        }
        
        function calculateSettlement() {
             if(people.length<2 || splitExpenses.length===0) return alert("資料不足");
             let bal = {}; people.forEach(p=>bal[p]=0);
             splitExpenses.forEach(e => {
                 let val = e.amountTWD;
                 if(!val) val = e.currency==='JPY'?Math.round(e.amount*(e.rate||0.22)):e.amount;
                 if(!people.includes(e.payer)) if(bal[e.payer]===undefined) bal[e.payer]=0;
                 bal[e.payer] += val;
                 const split = val/e.involved.length;
                 e.involved.forEach(p => { if(!people.includes(p)) if(bal[p]===undefined) bal[p]=0; bal[p] -= split; });
             });
             
             let db = [], cr = [];
             for(const [p,a] of Object.entries(bal)) {
                 const r = Math.round(a*100)/100;
                 if(r<-1) db.push({p,a:r});
                 else if(r>1) cr.push({p,a:r});
             }
             db.sort((a,b)=>a.a-b.a); cr.sort((a,b)=>b.a-a.a);
             
             let res = [], i=0, j=0;
             while(i<db.length && j<cr.length) {
                 let d = db[i], c = cr[j];
                 let amt = Math.min(Math.abs(d.a), c.a);
                 if(amt>=1) res.push(`${d.p} 給 ${c.p} : <span class="font-bold text-yellow-300">NT$ ${Math.round(amt)}</span>`);
                 d.a += amt; c.a -= amt;
                 if(Math.abs(d.a)<1) i++; if(c.a<1) j++;
             }
             document.getElementById('settlement-results').innerHTML = res.length ? res.map(t=>`<p class="border-b border-white/20 pb-2">${t}</p>`).join('') : '<p class="text-white/80">已平衡</p>';
        }

        /* --- 3. BOOKKEEPING --- */
        let currentExpensePhoto = null;
        let editingExpenseId = null;

        async function fetchLiveRate() {
            document.getElementById('rate-status').innerText = "更新...";
            try {
                const r = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const d = await r.json();
                document.getElementById('exchange-rate').value = d.rates.TWD;
                document.getElementById('rate-status').innerText = "已更新";
                updateTotalDisplay();
                const splitRate = document.getElementById('split-rate');
                if(splitRate && !splitRate.value) splitRate.value = d.rates.TWD;
            } catch(e) { document.getElementById('rate-status').innerText = "失敗"; }
        }

        function updateTotalDisplay() {
            let twd=0, jpy=0;
            expenses.forEach(e => {
                 if(e.currency==='JPY') { jpy+=e.amount; twd+=Math.round(e.amount*e.rate); }
                 else { twd+=e.amount; jpy+=Math.round(e.amount/e.rate); }
            });
            document.getElementById('total-twd-display').innerText = twd.toLocaleString();
            document.getElementById('total-jpy-display').innerText = jpy.toLocaleString();
        }

        function openExpenseModal() {
            editingExpenseId = null;
            document.getElementById('expense-modal-title').innerText = "新增記帳";
            document.getElementById('modal-expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-expense-item').value = "";
            document.getElementById('modal-expense-amount').value = "";
            document.getElementById('modal-expense-note').value = "";
            clearModalPhoto();
            document.getElementById('expense-modal').classList.remove('hidden');
        }
        function closeExpenseModal() { document.getElementById('expense-modal').classList.add('hidden'); }
        
        function updateModalCurrencyLabel() {
            const c = document.querySelector('input[name="currency"]:checked').value;
            document.getElementById('modal-currency-symbol').innerText = c==='JPY'?'¥':'NT$';
        }
        
        function previewImageModal(input) {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = function(e) {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = function() {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const s = 300/img.width; c.width=300; c.height=img.height*s;
                        ctx.drawImage(img,0,0,c.width,c.height);
                        currentExpensePhoto = c.toDataURL('image/jpeg', 0.7);
                        document.getElementById('modal-photo-preview').src = currentExpensePhoto;
                        document.getElementById('modal-photo-preview-container').classList.remove('hidden');
                    }
                };
                r.readAsDataURL(input.files[0]);
            }
        }
        function clearModalPhoto() { currentExpensePhoto = null; document.getElementById('modal-photo-preview-container').classList.add('hidden'); document.getElementById('modal-expense-photo').value=''; }
        
        function saveExpenseFromModal() {
            const item = document.getElementById('modal-expense-item').value;
            const amount = parseFloat(document.getElementById('modal-expense-amount').value);
            if(!item || isNaN(amount)) return alert("資料不完整");
            
            const obj = {
                id: editingExpenseId || Date.now(),
                date: document.getElementById('modal-expense-date').value,
                item, amount,
                currency: document.querySelector('input[name="currency"]:checked').value,
                category: document.querySelector('input[name="category"]:checked').value,
                payment: document.querySelector('input[name="payment"]:checked').value,
                note: document.getElementById('modal-expense-note').value,
                rate: parseFloat(document.getElementById('exchange-rate').value),
                photo: currentExpensePhoto
            };
            
            if(editingExpenseId) {
                const idx = expenses.findIndex(e=>e.id===editingExpenseId);
                if(idx!==-1) expenses[idx] = obj;
            } else {
                expenses.unshift(obj);
                expenses.sort((a,b) => new Date(b.date)-new Date(a.date));
            }
            saveData('expenses', expenses);
            renderExpenses(); updateTotalDisplay(); closeExpenseModal();
        }

        function editExpense(id) {
            const e = expenses.find(x=>x.id===id); if(!e) return;
            editingExpenseId = id;
            document.getElementById('expense-modal-title').innerText = "編輯記帳";
            document.getElementById('modal-expense-date').value = e.date;
            document.getElementById('modal-expense-item').value = e.item;
            document.getElementById('modal-expense-amount').value = e.amount;
            document.getElementById('modal-expense-note').value = e.note;
            document.querySelector(`input[name="currency"][value="${e.currency}"]`).checked=true;
            document.querySelector(`input[name="category"][value="${e.category}"]`).checked=true;
            document.querySelector(`input[name="payment"][value="${e.payment}"]`).checked=true;
            updateModalCurrencyLabel();
            currentExpensePhoto = e.photo;
            if(e.photo) { document.getElementById('modal-photo-preview').src = e.photo; document.getElementById('modal-photo-preview-container').classList.remove('hidden'); }
            else clearModalPhoto();
            document.getElementById('expense-modal').classList.remove('hidden');
        }

        function deleteExpense(id) {
            if(confirm("刪除?")) {
                expenses = expenses.filter(x=>x.id!==id);
                saveData('expenses', expenses);
                renderExpenses(); updateTotalDisplay();
            }
        }
        
        function viewExpensePhoto(id) {
            const e = expenses.find(x=>x.id===id);
            if(e && e.photo) {
                document.getElementById('photo-viewer-img').src = e.photo;
                document.getElementById('photo-viewer-modal').classList.remove('hidden');
            }
        }
        function closePhotoViewer() { document.getElementById('photo-viewer-modal').classList.add('hidden'); }

        const catIcons = { transport: 'fa-train-subway', food: 'fa-utensils', hotel: 'fa-bed', ticket: 'fa-ticket', shopping: 'fa-bag-shopping', other: 'fa-ellipsis' };
        const catColors = { transport: 'text-blue-400 bg-blue-50', food: 'text-orange-400 bg-orange-50', hotel: 'text-indigo-400 bg-indigo-50', ticket: 'text-purple-400 bg-purple-50', shopping: 'text-pink-400 bg-pink-50', other: 'text-gray-400 bg-gray-50' };

        function renderExpenses() {
            document.getElementById('expense-list').innerHTML = expenses.map(e => {
                const sym = e.currency==='JPY'?'¥':'NT$';
                const equiv = e.currency==='JPY' ? `≈ NT$${Math.round(e.amount*e.rate).toLocaleString()}` : `≈ ¥${Math.round(e.amount/e.rate).toLocaleString()}`;
                const icon = catIcons[e.category]||'fa-ellipsis';
                const col = catColors[e.category]||'bg-gray-100';
                return `
                <div class="bg-white p-3.5 rounded-xl border border-muji-border flex items-center shadow-sm relative">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center mr-3.5 ${col}"><i class="fa-solid ${icon} text-xl"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center text-xs text-gray-400 mb-0.5"><span class="mr-2">${e.date}</span><span><i class="fa-solid ${e.payment==='card'?'fa-credit-card':'fa-coins'} mr-1"></i>${e.payment==='card'?'信用卡':'現金'}</span></div>
                        <div class="font-bold text-gray-800 text-sm mb-0.5 truncate">${e.item}</div>
                        <div class="text-xs text-gray-400">${equiv} ${e.photo?`<button onclick="viewExpensePhoto(${e.id});event.stopPropagation()"><i class="fa-solid fa-image ml-1 text-muji-highlight"></i></button>`:''} ${e.note?'<i class="fa-solid fa-comment-dots ml-1 text-muji-accent"></i>':''}</div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="font-bold text-muji-highlight mb-1.5 text-base">${sym} ${e.amount.toLocaleString()}</div>
                        <div class="flex space-x-2"><button onclick="editExpense(${e.id})" class="text-gray-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteExpense(${e.id})" class="text-red-300"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                </div>`;
            }).join('');
        }

        /* --- 4. LISTS --- */
        let currentShoppingPhoto=null; let editingShoppingId=null;
        
        function renderTodos() {
            document.getElementById('checklist-container').innerHTML = todos.map((t,i) => `
                <div class="p-4 flex items-center justify-between hover:bg-blue-50/50 transition">
                    <div class="flex items-center custom-checkbox cursor-pointer flex-1" onclick="toggleTodo(${i})"><input type="checkbox" class="hidden" ${t.done?'checked':''}><div class="w-5 h-5 border-2 border-gray-300 rounded mr-3 relative bg-white transition-colors"></div><span class="text-sm font-medium ${t.done?'line-through text-gray-400':'text-gray-700'}">${t.text}</span></div>
                    <div class="flex space-x-2"><button onclick="editTodo(${i})" class="text-gray-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteTodo(${i})" class="text-gray-300"><i class="fa-solid fa-trash"></i></button></div>
                </div>`).join('');
        }
        function toggleTodo(i) { todos[i].done=!todos[i].done; saveData('todos',todos); renderTodos(); }
        function addTodo() { const v = document.getElementById('new-todo').value.trim(); if(v) { todos.push({text:v,done:false}); saveData('todos',todos); document.getElementById('new-todo').value=''; renderTodos(); } }
        function editTodo(i) { const v = prompt("編輯", todos[i].text); if(v) { todos[i].text=v; saveData('todos',todos); renderTodos(); } }
        function deleteTodo(i) { if(confirm("刪除?")) { todos.splice(i,1); saveData('todos',todos); renderTodos(); } }

        function openShoppingModal() { editingShoppingId=null; document.getElementById('shopping-modal-title').innerText="新增待買"; document.getElementById('shopping-name').value=''; document.getElementById('shopping-amount').value=''; clearShoppingPhoto(); document.getElementById('shopping-modal').classList.remove('hidden'); }
        function closeShoppingModal() { document.getElementById('shopping-modal').classList.add('hidden'); }
        function previewShoppingImage(i) { previewImageModal(i); } // Reuse preview logic but assign to shopping var
        // Wait, reuse logic needs careful variable assignment. Let's dupe for safety or use param.
        // Actually the previewImageModal assigns to currentExpensePhoto. Let's make a specific one.
        function previewShoppingImage(input) {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = function(e) {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = function() {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const s = 300/img.width; c.width=300; c.height=img.height*s;
                        ctx.drawImage(img,0,0,c.width,c.height);
                        currentShoppingPhoto = c.toDataURL('image/jpeg', 0.7);
                        document.getElementById('shopping-photo-preview').src = currentShoppingPhoto;
                        document.getElementById('shopping-photo-preview-container').classList.remove('hidden');
                    }
                };
                r.readAsDataURL(input.files[0]);
            }
        }
        function clearShoppingPhoto() { currentShoppingPhoto=null; document.getElementById('shopping-photo-preview-container').classList.add('hidden'); document.getElementById('shopping-photo').value=''; }
        
        function saveShoppingItem() {
            const name = document.getElementById('shopping-name').value;
            const amount = document.getElementById('shopping-amount').value;
            if(!name) return alert("請輸入名稱");
            const obj = { id: editingShoppingId||Date.now(), name, amount, photo: currentShoppingPhoto, checked: false };
            if(editingShoppingId) { const idx = shoppingList.findIndex(x=>x.id===editingShoppingId); if(idx!==-1) { obj.checked=shoppingList[idx].checked; shoppingList[idx]=obj; } }
            else shoppingList.push(obj);
            saveData('shoppingList', shoppingList); renderShoppingList(); closeShoppingModal();
        }

        function editShoppingItem(id) {
            const i = shoppingList.find(x=>x.id===id); if(!i) return;
            editingShoppingId=id;
            document.getElementById('shopping-modal-title').innerText="編輯待買";
            document.getElementById('shopping-name').value=i.name;
            document.getElementById('shopping-amount').value=i.amount;
            currentShoppingPhoto=i.photo;
            if(i.photo) { document.getElementById('shopping-photo-preview').src=i.photo; document.getElementById('shopping-photo-preview-container').classList.remove('hidden'); }
            else clearShoppingPhoto();
            document.getElementById('shopping-modal').classList.remove('hidden');
        }
        function deleteShoppingItem(id) { if(confirm("刪除?")) { shoppingList=shoppingList.filter(x=>x.id!==id); saveData('shoppingList',shoppingList); renderShoppingList(); } }
        function toggleShoppingItem(id) { const i = shoppingList.find(x=>x.id===id); if(i) { i.checked=!i.checked; saveData('shoppingList',shoppingList); renderShoppingList(); } }
        function viewShoppingPhoto(id) { const i = shoppingList.find(x=>x.id===id); if(i&&i.photo) { document.getElementById('photo-viewer-img').src=i.photo; document.getElementById('photo-viewer-modal').classList.remove('hidden'); } }

        function renderShoppingList() {
            const c = document.getElementById('shopping-list-container');
            if(!shoppingList.length) return c.innerHTML='<div class="text-center text-gray-400 text-sm py-4">無資料</div>';
            c.innerHTML = shoppingList.map(i => `
                <div class="bg-white p-3 rounded-xl border border-muji-border shadow-sm flex items-center justify-between relative ${i.checked?'bg-gray-50':''}">
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="flex items-center custom-checkbox cursor-pointer mr-3" onclick="toggleShoppingItem(${i.id})"><input type="checkbox" class="hidden" ${i.checked?'checked':''}><div class="w-5 h-5 border-2 border-gray-300 rounded relative bg-white transition-colors"></div></div>
                        ${i.photo?`<img src="${i.photo}" onclick="viewShoppingPhoto(${i.id})" class="w-10 h-10 rounded object-cover border border-gray-200 mr-3 cursor-zoom-in">`:''}
                        <div class="flex-1 min-w-0"><div class="text-sm font-bold text-gray-700 truncate ${i.checked?'line-through text-gray-400':''}">${i.name}</div>${i.amount?`<div class="text-xs text-muji-highlight font-medium">預算: ${i.amount}</div>`:''}</div>
                    </div>
                    <div class="flex space-x-2 pl-2"><button onclick="editShoppingItem(${i.id})" class="text-gray-400"><i class="fa-solid fa-pen"></i></button><button onclick="deleteShoppingItem(${i.id})" class="text-gray-300"><i class="fa-solid fa-trash-can"></i></button></div>
                </div>`).join('');
        }

        /* --- 5. INFO --- */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const map = { 'plan':0, 'split':1, 'wallet':2, 'lists':3, 'info':4 };
            const btns = document.querySelectorAll('.nav-btn');
            if(btns[map[tabId]]) btns[map[tabId]].classList.add('active');
            window.scrollTo(0, 0);
        }

        const japanesePhrases = [{category:"基本",items:[{jp:"こんにちは",roma:"Konnichiwa",tw:"你好"},{jp:"ありがとう",roma:"Arigatou",tw:"謝謝"},{jp:"すみません",roma:"Sumimasen",tw:"不好意思"}]},{category:"交通",items:[{jp:"ここはどこですか",roma:"Koko wa doko desuka",tw:"這裡是哪裡"},{jp:"トイレはどこですか",roma:"Toire wa doko desuka",tw:"廁所在哪"}]},{category:"購物",items:[{jp:"いくらですか",roma:"Ikura desuka",tw:"多少錢"},{jp:"これをください",roma:"Kore o kudasai",tw:"我要這個"}]}];

        function renderJapanesePhrases() {
            document.getElementById('japanese-phrases-container').innerHTML = japanesePhrases.map((c,i) => `
                <details class="group bg-blue-50/50 rounded-lg border border-blue-100 overflow-hidden mb-2">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-3 text-muji-text bg-blue-50 hover:bg-blue-100 transition"><span class="flex items-center"><span class="bg-muji-highlight text-white text-xs font-bold px-2 py-0.5 rounded-full mr-2">${i+1}</span>${c.category}</span><span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down text-xs text-gray-400"></i></span></summary>
                    <div class="text-gray-600 divide-y divide-gray-100">${c.items.map(t=>`<div class="p-3 hover:bg-white transition"><div class="font-bold text-muji-accent text-base mb-1">${t.jp}</div><div class="text-xs text-gray-400 font-mono mb-1">${t.roma}</div><div class="text-sm text-gray-600">${t.tw}</div></div>`).join('')}</div>
                </details>`).join('');
        }

        const memoArea = document.getElementById('memo-area');
        memoArea.value = localStorage.getItem('memo') || '';
        memoArea.addEventListener('blur', () => { saveData('memo', memoArea.value); extractLinks(memoArea.value); });
        function extractLinks(text) {
             const m = text.match(/(https?:\/\/[^\s]+)/g);
             document.getElementById('memo-links').innerHTML = m ? m.map(u => `<a href="${u}" target="_blank" class="block w-full bg-white border border-muji-border rounded-lg p-3 text-xs text-blue-500 truncate hover:bg-blue-50 flex items-center shadow-sm mt-2"><i class="fa-solid fa-link mr-2 text-gray-400"></i> ${u}</a>`).join('') : '';
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderItinerary();
            renderPeople();
            renderSplitList();
            renderExpenses();
            renderTodos();
            renderShoppingList();
            renderJapanesePhrases();
            extractLinks(memoArea.value);
            updateTotalDisplay();
            fetchLiveRate();
            
            // Re-init listener if config exists
            if(window.db) initFirebaseListener();
        });
    </script>
</body>
</html>